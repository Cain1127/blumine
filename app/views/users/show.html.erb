<article class="module width_full">
  <header>
    <h3><%= t(:account_details) %></h3>
  </header>

  <div class="module_content">
    <table>
        <tr>
          <td><%= t(:date_joined) %></td>
          <td><%= time_ago_in_words(@user.created_at) + t(:ago) %></td>
        </tr>
        <tr>
          <td><%= t(:default_locale) %></td>
          <td><%= User::AVAILABLE_LANGUAGES[@user.locale ? @user.locale.to_sym : I18n.default_locale] %></td>
        </tr>
        <% if @user.role %>
        <tr>
          <td><%= t('role.name') %></td>
          <td><%= render 'shared/role', :role => @user.role_name %></td>
        </tr>
        <% end %>
    </table>
    <% if @my_profile %>
    <% content_for :on_ready_hook do %>
      $(".draggable").draggable();
      $("table.calendar td").droppable({
        drop: function(event, ui) {
          var col = $(this);
          
          var issue_id = ui.draggable.attr('data-id');
          var date = col.attr('data-value');

          $.post('/issues/' + issue_id + '/planning', {date: date}, function(response) {
            if (response['success']) {
              col.effect('highlight');
            } else {
              col.css('backgroundColor', 'red');
            }
          }, 'json');
        },
        accept: '.draggable'
      });
    <% end %>
  <% end %>
  </div>
</article>

<article class="module width_full">
  <header>
    <h3><%= @my_profile ? t(:my_assigned_issues) : t('issue.issues_assigned_to', :username => @user.name) %></h3>
  </header>
  <div class="module_content">
    <div id="calendar">
      <% today = Date.today %>
      <% this_month = today.month %>
      <% beginning = today.beginning_of_week.yesterday %>
      <table border="0" class="calendar" cellspacing="0">
        <tr>
          <caption><%= t('date.month_names')[this_month] %></caption>
        </tr>
        <tr>
          <% (0..6).each do |i| %>
            <th><%= t('date.abbr_day_names')[i] %></th>
          <% end %>
        </tr>
        <% next_day = beginning.next %>
        <% 2.times do %>
        <tr>
          <% (0..6).each do %>
            <% class_name = [] %>
            <% if next_day.month != this_month %>
              <% class_name << 'other_month' %>
            <% end %>
            <% if next_day == today %>
              <% class_name << 'today' %>
            <% end %>
            <td class="<%= class_name.join(' ') %>" data-value="<%= next_day.to_s('%Y%M%d') %>">
              <%= next_day.day %>
            </td>
            <% next_day = next_day.next %>
          <% end %>
        </tr>
        <% end %>
      </table>
    </div>
    <div class="spacer"></div>
    <div id="my_assigned_issues" title="<%= t(:drag_issue_to_sort_priority) %>">
      <%= render :partial => 'my_assigned_issue',
        :collection => @user.assigned_issues.except_closed
      %>
    </div>
  </div>
</article>

<article class="module width_full">
  <header>
    <h3><%= t(:recently_created_issues) %></h3>
  </header>

  <div class="module_content">
    <%= render :partial => 'issues/issue',
      :collection => @user.issues.order('created_at DESC').limit(5), :as => :issue %>
  </div>
</article>
